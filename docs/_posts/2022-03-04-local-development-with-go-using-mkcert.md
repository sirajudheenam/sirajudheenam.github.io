---
layout: post
title:  "Local Go TLS Development with mkcert"
date:   2022-03-04 04:04:21 +0530
categories: go mkcert tls
---

Self-signed certificates are often hated by the browsers and provides warnings.
This article illustrates how to use [mkcert](https://github.com/FiloSottile/mkcert) to create a CA trust store locally for development purposes.

## Preparation

```bash
# On macOS 
brew install mkcert
brew install nss
```
## Certificate creation:
```bash
mkcert -install
# create certs for local dev
# two certificates namely example.com+5-key.pem and example.com+5.pem will be created
mkcert example.com "*.example.com" example.test localhost 127.0.0.1 ::1

# If you wish to install certs on others system than the one you created certs.
echo $(mkcert -CAROOT)
# on fish shell
# echo (mkcert -CAROOT)

ls $(mkcert -CAROOT)
rootCA-key.pem rootCA.pem
# follow this https://github.com/FiloSottile/mkcert#installing-the-ca-on-other-systems
```

## A TLS enabled Go HTTP Server
Create file called main.go and copy the below content
Note that it uses the certificate and key generated by `mkcert`.

```go
// https://github.com/denji/golang-tls
package main

import (
	"crypto/tls"
	"log"
	"net/http"
)

func main() {
    mux := http.NewServeMux()
    mux.HandleFunc("/", func(w http.ResponseWriter, req *http.Request) {
        w.Header().Add("Strict-Transport-Security", "max-age=63072000; includeSubDomains")
        w.Write([]byte("This is an example server.\n"))
    })
    cfg := &tls.Config{
        MinVersion:               tls.VersionTLS12,
        CurvePreferences:         []tls.CurveID{tls.CurveP521, tls.CurveP384, tls.CurveP256},
        PreferServerCipherSuites: true,
        CipherSuites: []uint16{
            tls.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,
            tls.TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,
            tls.TLS_RSA_WITH_AES_256_GCM_SHA384,
            tls.TLS_RSA_WITH_AES_256_CBC_SHA,
        },
    }
    srv := &http.Server{
        Addr:         ":443",
        Handler:      mux,
        TLSConfig:    cfg,
        TLSNextProto: make(map[string]func(*http.Server, *tls.Conn, http.Handler), 0),
    }
    log.Fatal(srv.ListenAndServeTLS("example.com+5.pem", "example.com+5-key.pem"))
}
```
Run the server

```bash
go run main.go
```
Click Allow on the prompt.

![AllowConnection](/assets/img/ALLOW_CONNECTION.png)

## Testing with curl
```bash
curl -I https://localhost:443

HTTP/1.1 200 OK
Strict-Transport-Security: max-age=63072000; includeSubDomains
Date: Fri, 04 Mar 2022 05:54:24 GMT
Content-Length: 27
Content-Type: text/plain; charset=utf-8
```
## Testing with browser

Point your browser to `https://localhost/`

![EXAMPLE_GO_TLS_SERVER](/assets/img/EXAMPLE_GO_TLS_SERVER.png)
